<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml"> 
<meta http-equiv="content-type" content="text/html; charset=UTF8">
<head>
<title>Test Page</title>
<script type="text/javascript" src="../libs/knockout-2.2.1.js"></script>
<script type="text/javascript" src="../libs/d3.v3.min.js"></script>
<script type="text/javascript" src="../tools.js"></script>
<script type="text/javascript" src="../charting.js"></script>
<script type="text/javascript" src="../kotools.js"></script>
<script type="text/javascript" src="../charts/barchart.js"></script>
<script type="text/javascript" src="../charts/linechart.js"></script>
<script type="text/javascript" src="../charts/piechart.js"></script>

<script>

var testOptions = { legend: true, width:300, height:150}

</script>
</head>
<body>
	<h2>Last Week Sales:</h2>
	<div id="carsChart" data-bind="piechart: cars, transformation:transformToChart, chartOptions:testOptions">

	</div>
	
	<h2>Monthly Sales</h2>
	<div id="monthlySales" data-bind="stackedbarchart: carSales, xcoord:'year'">

	</div>

	<h2>Monthly Sales</h2>
	<div id="lineChart" data-bind="linechart: expensesPerMonth, transformation:transformToLineChart">

	</div>
	
	<h2>Life Expenses</h2>
	<div id="lifeExpenses" data-bind="stackedbarchart: lifeExpenses, xcoord:'month'">

	</div>

	<h2>Sales per car mark</h2>
	 <!-- ko foreach: cars -->
	 	<div style="float:left;margin-right:10px">
		 	<h3 data-bind="text:name"></h3>
			<div data-bind="piechart: sales,transformation:transform2">

			</div>
	 	</div> 
	 <!-- /ko -->
		
</body>

<script>

//TODO: get rid of identity function if not needed
function identity(item){
	return item;
};

var carSales = [ 
	{
		year:'january',
		peugot: '100',
		audit: '200',
		bmw:'300'
	},
	{
		year:'february',
		peugot: '50',
		audit: '110',
		bmw:'80'
	},
	{
		year:'marz',
		peugot: '120',
		audit: '230',
		bmw:'115'
	}
]

var lastWeek = [
	{ 
		name: "peugot",
		sales: [ 
			{model: 'model1', amount:100},
			{model: 'model2', amount:200},
			{model: 'model3', amount:300}
		]
	},
	{ 
		name: "audi",
		sales: [
			{model: 'a3', amount:200},
			{model: 'qutro', amount:300},
			{model: 'a8', amount:100}
		]
	},
	{ 
		name: "bmw",
		sales: [
			{model: 'model5', amount:200},
			{model: 'model8', amount:100},
			{model: 'model3',amount:150}
		]
	},
]

var lifeExpenses = [
	{
		month: 'january',
		rent: -500,
		salary : 2200,
		parties : -300
	},
	{
		month: 'february',
		rent: -1000,
		salary : 1500,
		parties : -400
	},
	{
		month: 'marz',
		rent: -800,
		salary : 2500,
		parties : -800
	}	
]

function CarViewModel(data) {
	self = this;
	self.sales = ko.observableArray([]);
	self.name = ko.observable();
	
	self.totalSales = ko.computed(function(x) {
		return sum(self.sales().map(function(item){
			return item.amount;
		}));
	},self);
	
	if(data!=null){
		self.sales(data.sales);
		self.name(data.name);
	}
}

function TestViewModels (data, lastWeek, expenses){
	self = this;
	self.carSales = ko.observableArray([]);
	self.cars = ko.observableArray([]);
	self.lifeExpenses = ko.observableArray([]);
	self.expensesPerMonth = ko.observableArray([]);
	
	var keys = d3.keys(expenses[0]).filter(function (i) { return i != 'month';});
	var perMonth = keys.map(function(key){
		return {
			linename: key,
			data: expenses
		};
	});	

	self.expensesPerMonth(perMonth);
	self.carSales(data);
	self.lifeExpenses(expenses);
	self.cars(lastWeek.map(function(x) { return new CarViewModel(x);}));
}

function transformToLineChart(i){
	var months = {};
	months['january'] = 0;
	months['february'] = 1;
	months['marz'] = 2;

    return { 
    	x: i.linename, 
    	values: i.data.map(function(item){
    		return {x:months[item.month],y:item[i.linename]};
    	})
    };
}

function transformToChart(car){
	return { x: car.name(), y: car.totalSales()};
}

function transform2(car){
	return {x:car.model, y:car.amount };
}

var vm = new TestViewModels(carSales, lastWeek, lifeExpenses);

ko.applyBindings(vm);

</script>

</html>